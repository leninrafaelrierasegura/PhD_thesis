---
title: "Graphs"
date: "Last modified: `r format(Sys.time(), '%d-%m-%Y.')`"
output:
  html_document:
    mathjax: "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
    highlight: pygments
    theme: flatly
    code_folding: hide # class.source = "fold-hide" to hide code and add a button to show it
    df_print: paged
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    number_sections: true
    fig_caption: true
    code_download: true
    css: visual.css
always_allow_html: true
bibliography: 
  - references.bib
  - grateful-refs.bib
header-includes:
  - \newcommand{\ar}{\mathbb{R}}
  - \newcommand{\llav}[1]{\left\{#1\right\}}
  - \newcommand{\pare}[1]{\left(#1\right)}
  - \newcommand{\Ncal}{\mathcal{N}}
  - \newcommand{\Vcal}{\mathcal{V}}
  - \newcommand{\Ecal}{\mathcal{E}}
  - \newcommand{\Wcal}{\mathcal{W}}
  - \newcommand{\almosteverywhere}{\mathrm{a.e.}\;}
---

Go back to the [Contents](about.html) page.

<div style="color: #2c3e50; text-align: right;">
********  
<strong>Press Show to reveal the code chunks.</strong>  

********
</div>


```{r}
# Create a clipboard button on the rendered HTML page
source(here::here("clipboard.R")); clipboard
# Set seed for reproducibility
set.seed(1982) 
# Set global options for all code chunks
knitr::opts_chunk$set(
  # Disable messages printed by R code chunks
  message = FALSE,    
  # Disable warnings printed by R code chunks
  warning = FALSE,    
  # Show R code within code chunks in output
  echo = TRUE,        
  # Include both R code and its results in output
  include = TRUE,     
  # Evaluate R code chunks
  eval = TRUE,       
  # Enable caching of R code chunks for faster rendering
  cache = FALSE,      
  # Align figures in the center of the output
  fig.align = "center",
  # Enable retina display for high-resolution figures
  retina = 2,
  # Show errors in the output instead of stopping rendering
  error = TRUE,
  # Do not collapse code and output into a single block
  collapse = FALSE
)
# Start the figure counter
fig_count <- 0
# Define the captioner function
captioner <- function(caption) {
  fig_count <<- fig_count + 1
  paste0("Figure ", fig_count, ": ", caption)
}

```

```{r}
library(MetricGraph)
library(ggplot2)
library(reshape2)
library(dplyr)
library(viridis)
library(plotly)
library(patchwork)
library(slackr)
source("keys.R")
slackr_setup(token = token) # token comes from keys.R
```


```{r}
capture.output(
  knitr::purl(here::here("functionality1.Rmd"), output = here::here("functionality1.R")),
  file = here::here("old/purl_log.txt")
)
source(here::here("functionality1.R"))
```

```{r}
edges_roots_of_unity <- function(n, length = 10) {
  x_coords <- cos(2 * pi * (0:(n-1)) / n)
  y_coords <- sin(2 * pi * (0:(n-1)) / n)
  return(lapply(1:n, function(i) {rbind(c(0, 0), c(length*x_coords[i], length*y_coords[i]))}))
}
n <- 3
my_length <- 2
edges <-edges_roots_of_unity(n, length = my_length)
#edges[[1]] <- edges[[1]][2:1,]
graph <- metric_graph$new(edges = edges)
graph_disc <- graph$clone()
```



```{r}
graph$build_mesh(h = 0.02)
graph_disc$build_mesh(h = 0.02, continuous = FALSE)
```


# Example of a function $f\in C(\Gamma)\cap \mathcal{K}(\Gamma)\setminus C^1(\Gamma)$

Let us consider the $3$-star graph with common edge length $L$ and the following functions defined on each edge:

$$
f_1(s) = a + b_1 s - \frac{b_1 s^3}{3L^2}, \quad f_2(s) = a + b_2 s - \frac{b_2 s^3}{3L^2}, \quad f_3(s) = a + b_3 s - \frac{b_3 s^3}{3L^2}
$$
where $a$ is the value of the function at the central vertex and $b_1, b_2, b_3$ are constants such that $b_1 + b_2 + b_3 = 0$. Clearly $f = (f_e)_{e=1}^3$ is a continuous function defined on the graph as 

$$
f_1(0)= a, \quad f_2(0) = a, \quad f_3(0) = a.
$$

Now the derivative of $f$ on each edge is given by

$$
f_1'(s) = b_1 - \frac{b_1 s^2}{L^2}, \quad f_2'(s) = b_2 - \frac{b_2 s^2}{L^2}, \quad f_3'(s) = b_3 - \frac{b_3 s^2}{L^2}.
$$
and clearly $f' = (f_e')_{e=1}^3$ is discontinuous at the central vertex. The Kirchhoff vertex condition at the central vertex is satisfied since

$$
f_1'(0) + f_2'(0) + f_3'(0) = b_1 + b_2 + b_3 = 0.
$$

and at the outer vertices we have

$$
f_1'(L) = 0, \quad f_2'(L) = 0, \quad f_3'(L) = 0.
$$



```{r}
# General parameters
L <- my_length             # edge length
a <- 1             # value at central vertex
b <- c(1, 1, -2)   # b1+b2+b3 must be 0

f1 <- function(s) a + b[1]*s - b[1]*s^3/(3*L^2)
f2 <- function(s) a + b[2]*s - b[2]*s^3/(3*L^2)
f3 <- function(s) a + b[3]*s - b[3]*s^3/(3*L^2)


df1 <- function(s) b[1] - b[1]*s^2/L^2
df2 <- function(s) b[2] - b[2]*s^2/L^2
df3 <- function(s) b[3] - b[3]*s^2/L^2

f_list <- list(f1, f2, f3)

df_list <- list(df1, df2, df3)


```


```{r}
apply_edge_functions_fast <- function(graph, f_list) {
  
  if (length(f_list) != graph$nE) {
    stop(sprintf(
      "Number of functions (%d) must equal number of edges (%d).",
      length(f_list), graph$nE
    ))
  }
  VtE <- graph$mesh$VtE
  edge_lengths <- graph$edge_lengths
  
  edge   <- VtE[,1]
  s_norm <- VtE[,2]
  s_true <- s_norm * edge_lengths[edge]
  
  # s_true <- ifelse(graph$edge_orientation[edge] == -1,
  #                edge_lengths[edge] * (1 - s_norm),
  #                edge_lengths[edge] * s_norm)

  
  # out <- numeric(length(edge))
  # for (e in seq_len(graph$nE)) {
  #   idx <- which(edge == e)
  #   out[idx] <- f_list[[e]](s_true[idx])
  # }
  # return(out)
  out <- sapply(seq_len(nrow(VtE)), function(i) f_list[[edge[i]]](s_true[i]))
  return(out)
}
```




:::: {style="display: grid; grid-template-columns: 400px 400px 400px; grid-column-gap: 0px;"}


::: {}

```{r, eval =TRUE, fig.height = 6, out.width = "100%", fig.cap = captioner("Function $f = (f_e)_{e=1}^3$ given by $f_e(s) = a + b_e s - \\dfrac{b_e s^3}{3L^2}$ for $e=1,2,3$.")}
graph$plot_function(X = apply_edge_functions_fast(graph, f_list), vertex_size = 0, edge_width = 2, line_width = 3, type = "plotly") |> 
  config(mathjax = 'cdn') |>
  plotly::layout(title = TeX("f"), 
                 scene = list(
                   aspectratio = list(x = 2, 
                                 y = 2, 
                                 z = 2),
                   camera = list(eye = list(x = 4, 
                                       y = -1, 
                                       z = 4),
                            center = list(x = 0, 
                                          y = 0, 
                                          z = 0))
                 ))
```

:::


::: {}

```{r, eval =TRUE, fig.height = 6, out.width = "100%", fig.cap = captioner("Function $f' = (f_e')_{e=1}^3$ given by $f_e'(s) = b_e - \\dfrac{b_e s^2}{L^2}$ for $e=1,2,3$.")}
graph_disc$plot_function(X = apply_edge_functions_fast(graph_disc, df_list), vertex_size = 0, edge_width = 2, line_width = 3, continuous = FALSE, interpolate_plot = TRUE, type = "plotly") |> 
  config(mathjax = 'cdn') |>
  plotly::layout(title = TeX("f'"), 
                 scene = list(
                   aspectratio = list(x = 2, 
                                 y = 2, 
                                 z = 2),
                   camera = list(eye = list(x = 4, 
                                       y = -1, 
                                       z = 4),
                            center = list(x = 0, 
                                          y = 0, 
                                          z = 0))
                 ))
```


:::

::::


# Example of a function $g\in C^1(\Gamma)\cap \mathcal{K}(\Gamma)$

Let us consider the function $g = (g_e)_{e=1}^3$ defined on the $3$-star graph with common edge length $L$ as follows:

$$
g_1(s) = \cos\left(\frac{\pi s}{L}\right), \quad g_2(s) = \cos\left(\frac{\pi s}{L}\right), \quad g_3(s) = \cos\left(\frac{\pi s}{L}\right).
$$

Clearly $g$ is a continuous function defined on the graph as

$$
g_1(0) = 1, \quad g_2(0) = 1, \quad g_3(0) = 1.
$$

The derivative of $g$ on each edge is given by

$$
g_1'(s) = -\frac{\pi}{L}\sin\left(\frac{\pi s}{L}\right), \quad g_2'(s) = -\frac{\pi}{L}\sin\left(\frac{\pi s}{L}\right), \quad g_3'(s) = -\frac{\pi}{L}\sin\left(\frac{\pi s}{L}\right).
$$
and clearly $g' = (g_e')_{e=1}^3$ is continuous at the central vertex. The Kirchhoff vertex condition at the central vertex is satisfied since

$$
g_1'(0) + g_2'(0) + g_3'(0) = 0.
$$

and at the outer vertices we have

$$
g_1'(L) = 0, \quad g_2'(L) = 0, \quad g_3'(L) = 0.
$$

```{r}
g1 <- function(s) cos(pi*s/L)
g2 <- function(s) cos(pi*s/L)
g3 <- function(s) cos(pi*s/L)

dg1 <- function(s) -pi/L*sin(pi*s/L)
dg2 <- function(s) -pi/L*sin(pi*s/L)
dg3 <- function(s) -pi/L*sin(pi*s/L)

g_list <- list(g1, g2, g3)
dg_list <- list(dg1, dg2, dg3)
```


:::: {style="display: grid; grid-template-columns: 400px 400px 400px; grid-column-gap: 0px;"}


::: {}

```{r, eval =TRUE, fig.height = 6, out.width = "100%", fig.cap = captioner("Function $g = (g_e)_{e=1}^3$ given by $g_e(s) = \\cos(\\dfrac{\\pi s}{L})$ for $e=1,2,3$.")}
graph$plot_function(X = apply_edge_functions_fast(graph, g_list), vertex_size = 0, edge_width = 2, line_width = 3, type = "plotly") |> 
  config(mathjax = 'cdn') |>
  plotly::layout(title = TeX("g"), 
                 scene = list(
                   aspectratio = list(x = 2, 
                                 y = 2, 
                                 z = 2),
                   camera = list(eye = list(x = 4, 
                                       y = -1, 
                                       z = 4),
                            center = list(x = 0, 
                                          y = 0, 
                                          z = 0))
                 ))
```

:::


::: {}

```{r, eval =TRUE, fig.height = 6, out.width = "100%", fig.cap = captioner("Function $g' = (g_e')_{e=1}^3$ given by $g_e'(s) = -\\dfrac{\\pi}{L}\\sin(\\dfrac{\\pi s}{L})$ for $e=1,2,3$.")}
graph$plot_function(X = apply_edge_functions_fast(graph, dg_list), vertex_size = 0, edge_width = 2, line_width = 3, type = "plotly") |> 
  config(mathjax = 'cdn') |>
  plotly::layout(title = TeX("g'"), 
                 scene = list(
                   aspectratio = list(x = 2, 
                                 y = 2, 
                                 z = 2),
                   camera = list(eye = list(x = 4, 
                                       y = -1, 
                                       z = 4),
                            center = list(x = 0, 
                                          y = 0, 
                                          z = 0))
                 ))
```


:::

::::




# References

```{r, eval =TRUE}
grateful::cite_packages(output = "paragraph", out.dir = ".")
```

