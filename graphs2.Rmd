---
title: "Graphs"
date: "Last modified: `r format(Sys.time(), '%d-%m-%Y.')`"
output:
  html_document:
    mathjax: "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
    highlight: pygments
    theme: flatly
    code_folding: hide # class.source = "fold-hide" to hide code and add a button to show it
    df_print: paged
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    number_sections: true
    fig_caption: true
    code_download: true
    css: visual.css
always_allow_html: true
bibliography: 
  - references.bib
  - grateful-refs.bib
header-includes:
  - \newcommand{\ar}{\mathbb{R}}
  - \newcommand{\llav}[1]{\left\{#1\right\}}
  - \newcommand{\pare}[1]{\left(#1\right)}
  - \newcommand{\Ncal}{\mathcal{N}}
  - \newcommand{\Vcal}{\mathcal{V}}
  - \newcommand{\Ecal}{\mathcal{E}}
  - \newcommand{\Wcal}{\mathcal{W}}
  - \newcommand{\almosteverywhere}{\mathrm{a.e.}\;}
---

Go back to the [Contents](about.html) page.

<div style="color: #2c3e50; text-align: right;">
********  
<strong>Press Show to reveal the code chunks.</strong>  

********
</div>


```{r}
# Create a clipboard button on the rendered HTML page
source(here::here("clipboard.R")); clipboard
# Set seed for reproducibility
set.seed(1982) 
# Set global options for all code chunks
knitr::opts_chunk$set(
  # Disable messages printed by R code chunks
  message = FALSE,    
  # Disable warnings printed by R code chunks
  warning = FALSE,    
  # Show R code within code chunks in output
  echo = TRUE,        
  # Include both R code and its results in output
  include = TRUE,     
  # Evaluate R code chunks
  eval = TRUE,       
  # Enable caching of R code chunks for faster rendering
  cache = FALSE,      
  # Align figures in the center of the output
  fig.align = "center",
  # Enable retina display for high-resolution figures
  retina = 2,
  # Show errors in the output instead of stopping rendering
  error = TRUE,
  # Do not collapse code and output into a single block
  collapse = FALSE
)
# Start the figure counter
fig_count <- 0
# Define the captioner function
captioner <- function(caption) {
  fig_count <<- fig_count + 1
  paste0("Figure ", fig_count, ": ", caption)
}

```

```{r}
library(MetricGraph)
library(ggplot2)
library(reshape2)
library(dplyr)
library(viridis)
library(plotly)
library(patchwork)
library(slackr)
source("keys.R")
slackr_setup(token = token) # token comes from keys.R
```


```{r}
capture.output(
  knitr::purl(here::here("functionality1.Rmd"), output = here::here("functionality1.R")),
  file = here::here("old/purl_log.txt")
)
source(here::here("functionality1.R"))
```

```{r}
edges_roots_of_unity <- function(n, length = 10) {
  x_coords <- cos(2 * pi * (0:(n-1)) / n)
  y_coords <- sin(2 * pi * (0:(n-1)) / n)
  return(lapply(1:n, function(i) {rbind(c(0, 0), c(length*x_coords[i], length*y_coords[i]))}))
}
n <- 3
my_length <- 2
edges <-edges_roots_of_unity(n, length = my_length)
#edges[[1]] <- edges[[1]][2:1,]
graph <- metric_graph$new(edges = edges)
graph_disc <- graph$clone()
```



```{r}
h = 0.02
graph$build_mesh(h = h)
graph_disc$build_mesh(h = h, continuous = FALSE)
```




```{r}
apply_edge_functions_fast <- function(graph, f_list) {
  
  if (length(f_list) != graph$nE) {
    stop(sprintf(
      "Number of functions (%d) must equal number of edges (%d).",
      length(f_list), graph$nE
    ))
  }
  VtE <- graph$mesh$VtE
  edge_lengths <- graph$edge_lengths
  
  edge   <- VtE[,1]
  s_norm <- VtE[,2]
  s_true <- s_norm * edge_lengths[edge]
  
  # s_true <- ifelse(graph$edge_orientation[edge] == -1,
  #                edge_lengths[edge] * (1 - s_norm),
  #                edge_lengths[edge] * s_norm)

  
  # out <- numeric(length(edge))
  # for (e in seq_len(graph$nE)) {
  #   idx <- which(edge == e)
  #   out[idx] <- f_list[[e]](s_true[idx])
  # }
  # return(out)
  out <- sapply(seq_len(nrow(VtE)), function(i) f_list[[edge[i]]](s_true[i]))
  return(out)
}
```

# Example of a function $f\in C(\Gamma)\cap \mathcal{K}(\Gamma)\setminus C^1(\Gamma)$

Let us consider the $3$-star graph $\Gamma = (\mathcal{V}, \mathcal{E})$, where $\mathcal{V} = \{v_0, v_1, v_2, v_3\}$ and $\mathcal{E} = \{e_1, e_2, e_3\}$. Each edge $e_i$ has common length $\ell$ and connects the central vertex $v_0$ to the outer vertex $v_i$ for $i=1,2,3$ in such a way that $v_0 = \underline{e_1} = \underline{e_2} = \underline{e_3}$. On $\Gamma$ we define the function $f = \{f_e\}_{e\in\mathcal{E}}$ as follows:

$$
f_{e_1}(s) = a + b_1 s - \frac{b_1 s^3}{3\ell^2}, \quad f_{e_2}(s) = a + b_2 s - \frac{b_2 s^3}{3\ell^2}, \quad f_{e_3}(s) = a + b_3 s - \frac{b_3 s^3}{3\ell^2}
$$

where $a$ (to be chosen) is the value of $f$ at the central vertex and $b_1, b_2, b_3$ are constants (to be chosen) such that $b_1 + b_2 + b_3 = 0$. Clearly, $f$ is a continuous function since 

$$
f_{e_1}(0) = f_{e_2}(0) = f_{e_3}(0) = a.
$$

The derivative $f' = \{f'_e\}_{e\in\mathcal{E}}$ of $f$ on each edge is given by

$$
f_{e_1}'(s) = b_1 - \frac{b_1 s^2}{\ell^2}, \quad f_{e_2}'(s) = b_2 - \frac{b_2 s^2}{\ell^2}, \quad f_{e_3}'(s) = b_3 - \frac{b_3 s^2}{\ell^2}.
$$
Since $f_{e_1}'(0) = b_1$, $f_{e_2}'(0) = b_2$ and $f_{e_3}'(0) = b_3$, we can choose $b_1, b_2, b_3$ such that $f'$ is discontinuous at the central vertex and satisfies the Kirchhoff vertex conditions simultaneously. The Kirchhoff vertex conditions at the central vertex are satisfied since

$$
f_{e_1}'(0) + f_{e_2}'(0) + f_{e_3}'(0) = b_1 + b_2 + b_3 = 0.
$$

and at the outer vertices we have

$$
f_{e_1}'(\ell) =  f_{e_2}'(\ell) = f_{e_3}'(\ell) = 0.
$$

For instance, we can choose $b_1 = 1$, $b_2 = 1$ and $b_3 = -2$, as shown in the following plots of $f$ and $f'$. This choice ensures $f$ to be continuous and satisfy the Kirchhoff vertex conditions while $f'$ is discontinuous at the central vertex.



```{r}
# General parameters
L <- my_length             # edge length
a <- 1             # value at central vertex
b <- c(1, 1, -2)   # b1+b2+b3 must be 0

f1 <- function(s) a + b[1]*s - b[1]*s^3/(3*L^2)
f2 <- function(s) a + b[2]*s - b[2]*s^3/(3*L^2)
f3 <- function(s) a + b[3]*s - b[3]*s^3/(3*L^2)


df1 <- function(s) b[1] - b[1]*s^2/L^2
df2 <- function(s) b[2] - b[2]*s^2/L^2
df3 <- function(s) b[3] - b[3]*s^2/L^2

ddf1 <- function(s) -2*b[1]*s/L^2
ddf2 <- function(s) -2*b[2]*s/L^2
ddf3 <- function(s) -2*b[3]*s/L^2

dddf1 <- function(s) -2*b[1]/L^2
dddf2 <- function(s) -2*b[2]/L^2
dddf3 <- function(s) -2*b[3]/L^2

f_list <- list(f1, f2, f3)
df_list <- list(df1, df2, df3)
ddf_list <- list(ddf1, ddf2, ddf3)
dddf_list <- list(dddf1, dddf2, dddf3)

f <- apply_edge_functions_fast(graph, f_list)
df <- apply_edge_functions_fast(graph_disc, df_list)
ddf <- apply_edge_functions_fast(graph, ddf_list)
dddf <- apply_edge_functions_fast(graph_disc, dddf_list)
```


```{r}
l_mesh <- seq(0, my_length, by = h)
dfl1 <- df1(l_mesh)
dfl2 <- df2(l_mesh)
dfl3 <- df3(l_mesh)

l_mesh_norm <- l_mesh/my_length
PtE1 <- cbind(rep(1, length(l_mesh)), l_mesh_norm)
PtE2 <- cbind(rep(2, length(l_mesh)), l_mesh_norm)
PtE3 <- cbind(rep(3, length(l_mesh)), l_mesh_norm)
XY1 <- graph$coordinates(PtE1)
XY2 <- graph$coordinates(PtE2)
XY3 <- graph$coordinates(PtE3)
DF1 <- data.frame(x = XY1[,1], y = XY1[,2], z = dfl1)
DF2 <- data.frame(x = XY2[,1], y = XY2[,2], z = dfl2)
DF3 <- data.frame(x = XY3[,1], y = XY3[,2], z = dfl3)

DF <- rbind(DF1, rep(NA, 3), DF2, rep(NA, 3), DF3)
DF_NO_NA <- rbind(DF1, DF2, DF3)
```

```{r}
x_eye <- 5#8
y_eye <- -1#-2
z_eye <- 2#3
```

```{r, eval =TRUE, fig.height = 4, out.width = "100%", fig.cap = captioner("Function $f' = \\{f'_e\\}_{e\\in\\mathcal{E}}$ given by $f_{e_i}'(s) = b_i - \\dfrac{b_i s^2}{\\ell^2}$ for $i=1,2,3$.")}
graph_disc$plot_function(X = df, vertex_size = 0, edge_width = 3, line_width = 3, continuous = FALSE, interpolate_plot = TRUE, type = "plotly") |> 
  config(mathjax = 'cdn') |>
  plotly::layout(title = TeX("f'"), 
                 scene = list(
                   aspectratio = list(x = 2, 
                                 y = 2, 
                                 z = 2),
                   camera = list(eye = list(x = x_eye, 
                                       y = y_eye, 
                                       z = z_eye),
                            center = list(x = 0, 
                                          y = 0, 
                                          z = 0))
                 ))
```


:::: {style="display: grid; grid-template-columns: 400px 400px 400px 400px; grid-column-gap: 0px;"}


::: {}

```{r, eval =TRUE, fig.height = 4, out.width = "100%", fig.cap = captioner("Function $f = \\{f_e\\}_{e\\in\\mathcal{E}}$ given by $f_{e_i}(s) = a + b_i s - \\dfrac{b_i s^3}{3\\ell^2}$ for $i=1,2,3$.")}
graph$plot_function(X = f, vertex_size = 0, edge_width = 3, line_width = 3, type = "plotly") |> 
  config(mathjax = 'cdn') |>
  plotly::layout(title = TeX("f"), 
                 scene = list(
                   aspectratio = list(x = 2, 
                                 y = 2, 
                                 z = 2),
                   camera = list(eye = list(x = x_eye, 
                                       y = y_eye, 
                                       z = z_eye),
                            center = list(x = 0, 
                                          y = 0, 
                                          z = 0))
                 ))
```






:::


::: {}


```{r, eval =TRUE, fig.height = 4, out.width = "100%", fig.cap = captioner("Function $f' = \\{f'_e\\}_{e\\in\\mathcal{E}}$ given by $f_{e_i}'(s) = b_i - \\dfrac{b_i s^2}{\\ell^2}$ for $i=1,2,3$.")}
graph$plot_function(X = f*0, vertex_size = 0, line_color = "black", edge_width = 3, line_width = 3, type = "plotly") |>
  add_trace(data = DF,
            x = ~y, 
            y = ~x, 
            z = ~z, 
            type = "scatter3d",
            mode = "lines",  
            line = list(color = "blue", width = 3),
            showlegend = FALSE) |>
  add_trace(x = rep(DF_NO_NA$y, each = 3), 
            y = rep(DF_NO_NA$x, each = 3), 
            z = unlist(lapply(DF_NO_NA$z, function(zj) c(0, zj, NA))),
            type = "scatter3d", 
            mode = "lines",
            line = list(color = "gray", width = 0.5),
            showlegend = FALSE) |>
  config(mathjax = 'cdn') |>
  plotly::layout(title = TeX("f'"), 
                 scene = list(
                   aspectratio = list(x = 2, 
                                 y = 2, 
                                 z = 2),
                   camera = list(eye = list(x = x_eye, 
                                       y = y_eye, 
                                       z = z_eye),
                            center = list(x = 0, 
                                          y = 0, 
                                          z = 0))
                 ))
```



:::

::: {}

```{r, eval =TRUE, fig.height = 4, out.width = "100%", fig.cap = captioner("Function $f'' = \\{f''_e\\}_{e\\in\\mathcal{E}}$ given by $f_{e_i}''(s) = -\\dfrac{2 b_i s}{\\ell^2}$ for $i=1,2,3$.")}
graph$plot_function(X = ddf, vertex_size = 0, edge_width = 3, line_width = 3, continuous = TRUE, interpolate_plot = TRUE, type = "plotly") |> 
  config(mathjax = 'cdn') |>
  plotly::layout(title = TeX("f''"), 
                 scene = list(
                   aspectratio = list(x = 2, 
                                 y = 2, 
                                 z = 2),
                   camera = list(eye = list(x = x_eye, 
                                       y = y_eye, 
                                       z = z_eye),
                            center = list(x = 0, 
                                          y = 0, 
                                          z = 0))
                 ))
```


:::

::: {}

```{r, eval =TRUE, fig.height = 4, out.width = "100%", fig.cap = captioner("Function $f''' = \\{f'''_e\\}_{e\\in\\mathcal{E}}$ given by $f_{e_i}'''(s) = -\\dfrac{2 b_i}{\\ell^2}$ for $i=1,2,3$.")}
graph_disc$plot_function(X = dddf, vertex_size = 0, edge_width = 3, line_width = 3, continuous = FALSE, interpolate_plot = TRUE, type = "plotly") |> 
  config(mathjax = 'cdn') |>
  plotly::layout(title = TeX("f'''"), 
                 scene = list(
                   aspectratio = list(x = 2, 
                                 y = 2, 
                                 z = 2),
                   camera = list(eye = list(x = x_eye, 
                                       y = y_eye, 
                                       z = z_eye),
                            center = list(x = 0, 
                                          y = 0, 
                                          z = 0))
                 ))
```


:::

::::


# Example of a function $g\in C^1(\Gamma)\cap \mathcal{K}(\Gamma)$

Let us consider the function $g = \{g_e\}_{e\in\mathcal{E}}$ defined on the $3$-star graph with common edge length $\ell$ as follows:
$$
g_{e_1}(s) = \cos\left(\frac{\pi s}{\ell}\right), \quad g_{e_2}(s) = \cos\left(\frac{\pi s}{\ell}\right), \quad g_{e_3}(s) = \cos\left(\frac{\pi s}{\ell}\right).
$$
Clearly, $g$ is a continuous function defined on the graph since
$$
g_{e_1}(0) =  g_{e_2}(0) =  g_{e_3}(0) = 1.
$$
The derivative $g' = \{g'_e\}_{e\in\mathcal{E}}$  of $g$ on each edge is given by
$$
g_{e_1}'(s) = -\frac{\pi}{\ell}\sin\left(\frac{\pi s}{\ell}\right), \quad g_{e_2}'(s) = -\frac{\pi}{\ell}\sin\left(\frac{\pi s}{\ell}\right), \quad g_{e_3}'(s) = -\frac{\pi}{\ell}\sin\left(\frac{\pi s}{\ell}\right).
$$
Since $g_{e_1}'(0) = g_{e_2}'(0) = g_{e_3}'(0) = 0$, $g$ satisfies the Kirchhoff vertex conditions
$$
g_{e_1}'(0) + g_{e_2}'(0) + g_{e_3}'(0) = 0\text{ and }g_{e_1}'(\ell) =  g_{e_2}'(\ell) =  g_{e_3}'(\ell) = 0,
$$
Moreover, $g'$ is a continuous function.


```{r}
g1 <- function(s) cos(pi*s/L)
g2 <- function(s) cos(pi*s/L)
g3 <- function(s) cos(pi*s/L)

dg1 <- function(s) -pi/L*sin(pi*s/L)
dg2 <- function(s) -pi/L*sin(pi*s/L)
dg3 <- function(s) -pi/L*sin(pi*s/L)

ddg1 <- function(s) -pi^2/L^2*cos(pi*s/L)
ddg2 <- function(s) -pi^2/L^2*cos(pi*s/L)
ddg3 <- function(s) -pi^2/L^2*cos(pi*s/L)

dddg1 <- function(s) pi^3/L^3*sin(pi*s/L)
dddg2 <- function(s) pi^3/L^3*sin(pi*s/L)
dddg3 <- function(s) pi^3/L^3*sin(pi*s/L)

g_list <- list(g1, g2, g3)
dg_list <- list(dg1, dg2, dg3)
ddg_list <- list(ddg1, ddg2, ddg3)
dddg_list <- list(dddg1, dddg2, dddg3)

g <- apply_edge_functions_fast(graph, g_list)
dg <- apply_edge_functions_fast(graph, dg_list)
ddg <- apply_edge_functions_fast(graph, ddg_list)
dddg <- apply_edge_functions_fast(graph, dddg_list)
```


:::: {style="display: grid; grid-template-columns: 400px 400px 400px 400px; grid-column-gap: 0px;"}


::: {}

```{r, eval =TRUE, fig.height = 4, out.width = "100%", fig.cap = captioner("Function $g = \\{g_e\\}_{e\\in\\mathcal{E}}$ given by $g_{e_i}(s) = \\cos(\\dfrac{\\pi s}{\\ell})$ for $i=1,2,3$.")}
graph$plot_function(X = g, vertex_size = 0, edge_width = 3, line_width = 3, type = "plotly") |> 
  config(mathjax = 'cdn') |>
  plotly::layout(title = TeX("g"), 
                 scene = list(
                   aspectratio = list(x = 2, 
                                 y = 2, 
                                 z = 2),
                   camera = list(eye = list(x = x_eye, 
                                       y = y_eye, 
                                       z = z_eye),
                            center = list(x = 0, 
                                          y = 0, 
                                          z = 0))
                 ))
```

:::


::: {}

```{r, eval =TRUE, fig.height = 4, out.width = "100%", fig.cap = captioner("Function $g' = \\{g'_e\\}_{e\\in\\mathcal{E}}$ given by $g_{e_i}'(s) = -\\dfrac{\\pi}{\\ell}\\sin(\\dfrac{\\pi s}{\\ell})$ for $i=1,2,3$.")}
graph$plot_function(X = dg, vertex_size = 0, edge_width = 3, line_width = 3, type = "plotly") |> 
  config(mathjax = 'cdn') |>
  plotly::layout(title = TeX("g'"), 
                 scene = list(
                   aspectratio = list(x = 2, 
                                 y = 2, 
                                 z = 2),
                   camera = list(eye = list(x = x_eye, 
                                       y = y_eye, 
                                       z = z_eye),
                            center = list(x = 0, 
                                          y = 0, 
                                          z = 0))
                 ))
```


:::

::: {}

```{r, eval =TRUE, fig.height = 4, out.width = "100%", fig.cap = captioner("Function $g'' = \\{g''_e\\}_{e\\in\\mathcal{E}}$ given by $g_{e_i}''(s) = -\\dfrac{\\pi^2}{\\ell^2}\\cos(\\dfrac{\\pi s}{\\ell})$ for $i=1,2,3$.")}
graph$plot_function(X = ddg, vertex_size = 0, edge_width = 3, line_width = 3, type = "plotly") |> 
  config(mathjax = 'cdn') |>
  plotly::layout(title = TeX("g''"), 
                 scene = list(
                   aspectratio = list(x = 2, 
                                 y = 2, 
                                 z = 2),
                   camera = list(eye = list(x = x_eye, 
                                       y = y_eye, 
                                       z = z_eye),
                            center = list(x = 0, 
                                          y = 0, 
                                          z = 0))
                 ))
```


:::

::: {}

```{r, eval =TRUE, fig.height = 4, out.width = "100%", fig.cap = captioner("Function $g''' = \\{g'''_e\\}_{e\\in\\mathcal{E}}$ given by $g_{e_i}'''(s) = \\dfrac{\\pi^3}{\\ell^3}\\sin(\\dfrac{\\pi s}{\\ell})$ for $i=1,2,3$.")}
graph$plot_function(X = dddg, vertex_size = 0, edge_width = 3, line_width = 3, type = "plotly") |> 
  config(mathjax = 'cdn') |>
  plotly::layout(title = TeX("g'''"), 
                 scene = list(
                   aspectratio = list(x = 2, 
                                 y = 2, 
                                 z = 2),
                   camera = list(eye = list(x = x_eye, 
                                       y = y_eye, 
                                       z = z_eye),
                            center = list(x = 0, 
                                          y = 0, 
                                          z = 0))
                 ))
```


:::

::::




# References

```{r, eval =TRUE}
grateful::cite_packages(output = "paragraph", out.dir = ".")
```

